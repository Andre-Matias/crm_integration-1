---
title: "Onboarding Otomoto PL - A/B Test Evaluation for users who finished onboarding "
output: html_document
---

```{r}
setwd("~/Documents/pwa_analysis")
source("pop_suc_test.R")   source functions needed to evaluate the test
```

# ##############################################################################################################
# Retention analysis OKR1, OKR2 for users that finished onboarding                                             #
# Test users that clicked on "search"" in homepage vs users that finished the onboarding ("see_results" click) #
# use datasets created in `queries_finish_onb.R` file                                                          #
# ##############################################################################################################


# ################################################################################################
# OKR 1:
# Increase % of new users that return to the website after 7 days by 10%
# ################################################################################################


# ##############################################################################
# 2nd week --------------------------------------------------------------------
# Mon 27 Nov - Sun 03 Dic  
```{r}
# First run queries
# Second import pop_suc() functions with specific period set
control <- pop_suc_okr1(df_any_pl, "2017-11-27", "2017-12-03", "rwd")
experiment <- pop_suc_okr1(df_any_pl_pwa, "2017-11-27", "2017-12-03", "rwd")
```

# Test dataset
```{r cars}
popA <- control$pop
popB <- experiment$pop
sucA <- control$suc
sucB <- experiment$suc

dfOnboarding <-
    data.frame(
        id = c("03", "04"),
        name = c("Original", "Variation with Onboarding"),
        period = c("2nd week", "2nd week"),
        PopulationMetric = c("new_users_search_home","new_users_finish_onboarding"),
        PopulationValue = c(popA, popB),
        SucessMetric = c("okr_1","okr_1"),
        SucessValue = c(sucA, sucB)
    )

dfOnboarding$ctr <- 
    dfOnboarding$SucessValue / dfOnboarding$PopulationValue
```

# Power analysis
```{r}
testResultsOnboarding <- 
    power.prop.test(
        n = dfOnboarding$PopulationValue, 
        p1 = dfOnboarding$ctr[1],
        p2 = dfOnboarding$ctr[2],
        sig.level = 0.05,
        alternative = "two.sided"
    )

testResultsOnboarding
```

Test is  significant.
Variation is just + 8% below original
```{r}
(testResultsOnboarding$p2 - testResultsOnboarding$p1) / testResultsOnboarding$p1
```

# ##############################################################################
# 3rd week --------------------------------------------------------------------
# Mon 04 Dec -Sun 10 Dec
```{r}
control <- pop_suc_okr1(df_any_pl, "2017-12-04", "2017-12-10", "rwd")
experiment <- pop_suc_okr1(df_any_pl_pwa, "2017-12-04", "2017-12-10", "rwd")
```


# Test dataset 
```{r cars}
popA <- control$pop
popB <- experiment$pop
sucA <- control$suc
sucB <- experiment$suc

dfOnboarding <-
    data.frame(
        id = c("03", "04"),
        name = c("Original", "Variation with Onboarding"),
        period = c("3rd week", "3rd week"),
        PopulationMetric = c("new_users_search_home","new_users_finish_onboarding"),
        PopulationValue = c(popA, popB),
        SucessMetric = c("okr_1","okr_1"),
        SucessValue = c(sucA, sucB)
    )

dfOnboarding$ctr <- 
    dfOnboarding$SucessValue / dfOnboarding$PopulationValue
```

# Power analysis
```{r}
testResultsOnboarding <- 
    power.prop.test(
        n = dfOnboarding$PopulationValue, 
        p1 = dfOnboarding$ctr[1],
        p2 = dfOnboarding$ctr[2],
        sig.level = 0.05,
        alternative = "two.sided"
    )

testResultsOnboarding
```
Test is significant
Variation is + 9% above original
```{r}
(testResultsOnboarding$p2 - testResultsOnboarding$p1) / testResultsOnboarding$p1
```



# Check OKR1 for users that clicked on skip_click button 
# use dataset created in `finish_onb.R` file
# ##############################################################################
# 2nd week --------------------------------------------------------------------
# Mon 27 Nov - Sun 03 Dic  
```{r}
# First run queries
# Second import pop_suc() functions with specific period set
skip_okr1 <- pop_suc_okr1(df_any_pl_pwa_skip, "2017-11-27", "2017-12-03", "rwd")
skip_okr1
```

# 3rd week
```{r}
# First run queries
# Second import pop_suc() functions with specific period set
skip_okr1 <- pop_suc_okr1(df_any_pl_pwa_skip, "2017-12-04", "2017-12-10", "rwd")
skip_okr1
```


# ################################################################################################
# OKR 2:
# Increase % of new users with 1+ reply after 14 days by 10%
# ################################################################################################


# ##############################################################################
# 2nd week --------------------------------------------------------------------
# Mon 27 Nov - Sun 03 Dic 
## because we noticed strange behaviour during 1st week 22-26 Nov
```{r}
# First import pop_suc() function with specific period set
control <- pop_suc_okr2 (df_lead_pl, "2017-11-27", "2017-12-03", "rwd")
experiment <- pop_suc_okr2 (df_lead_pl_pwa, "2017-11-27", "2017-12-03", "rwd")
```


# Test dataset
```{r cars}
popA <- control$pop
popB <- experiment$pop
sucA <- control$suc
sucB <- experiment$suc

dfOnboarding <-
    data.frame(
        id = c("01", "02"),
        name = c("Original", "Variation with Onboarding"),
        period = c("2nd week", "2nd week"),
        PopulationMetric = c("new_users_search_home","new_users_finish_onboarding"),
        PopulationValue = c(popA, popB),
        SucessMetric = c("okr_2","okr_2"),
        SucessValue = c(sucA, sucB)
    )

dfOnboarding$ctr <- 
    dfOnboarding$SucessValue / dfOnboarding$PopulationValue
```

# Power analysis
```{r}
testResultsOnboarding <- 
    power.prop.test(
        n = dfOnboarding$PopulationValue, 
        p1 = dfOnboarding$ctr[1],
        p2 = dfOnboarding$ctr[2],
        sig.level = 0.05,
        alternative = "two.sided"
    )

testResultsOnboarding
```

Test is not significant
Variation is - 4% below original
```{r}
(testResultsOnboarding$p2 - testResultsOnboarding$p1) / testResultsOnboarding$p1
```


# #############################################################################
# Analyse OKR2 only on same day from 1st interaction
## use pop_suc_okr2_0() function
```{r}
# First import pop_suc() function with specific period set
control <- pop_suc_okr2_0 (df_lead_pl, "2017-11-27", "2017-12-03", "rwd")
experiment <- pop_suc_okr2_0 (df_lead_pl_pwa, "2017-11-27", "2017-12-03", "rwd")
```

# Test dataset
```{r cars}
popA <- control$pop
popB <- experiment$pop
sucA <- control$suc
sucB <- experiment$suc

dfOnboarding <-
    data.frame(
        id = c("03", "04"),
        name = c("Original", "Variation with Onboarding"),
        period = c("2nd week", "2nd week"),
        PopulationMetric = c("new_users_search_home","new_users_finish_onboarding"),
        PopulationValue = c(popA, popB),
        SucessMetric = c("okr_2_same_day","okr_2_same_day"),
        SucessValue = c(sucA, sucB)
    )

dfOnboarding$ctr <- 
    dfOnboarding$SucessValue / dfOnboarding$PopulationValue
```

# Power analysis
```{r}
testResultsOnboarding <- 
    power.prop.test(
        n = dfOnboarding$PopulationValue, 
        p1 = dfOnboarding$ctr[1],
        p2 = dfOnboarding$ctr[2],
        sig.level = 0.05,
        alternative = "two.sided"
    )

testResultsOnboarding
```

```{r}
(testResultsOnboarding$p2 - testResultsOnboarding$p1) / testResultsOnboarding$p1
```


# #############################################################################
# Check OKR2 for users that clicked on skip_click button 
# use dataset created in `finish_onb.R` file
# #############################################################################
# 2nd week --------------------------------------------------------------------
# Mon 27 Nov - Sun 03 Dic  
```{r}
# First run queries
# Second import pop_suc() functions with specific period set
skip_okr2 <- pop_suc_okr2(df_lead_pl_pwa_skip, "2017-11-27", "2017-12-03", "rwd")
skip_okr2
```

